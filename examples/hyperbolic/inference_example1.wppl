
// Hyperbolic Inference example 1: Naive Trajectory
// -- Goes from bottom to Donut North
// Inference should infer that Donut has [high,low] utility
// and Veg the opposite.


// TODO why does agent do weird thing when starting at [3,0]?
var start = { 
  loc : [3,1],
  terminateAfterAction : false,
  timeLeft : 13
};

var world = restaurantChoiceMDP;

// Create trajectory that we'll use to condition on

var donutUtility = makeDonutUtility(world, {
    'Donut N' : [10, -10],
    'Donut S' : [10, -10],
    'Veg'   : [-10, 20],
    'Noodle': [0, 0]
});


var actual_agent = makeHyperbolicDiscounter(
    { utility : donutUtility,
      alpha : 500, 
      discount : 1, 
      sophisticatedOrNaive  : 'sophisticated' 
    }, world);
var observed = simulateHyperbolic(start, world, actual_agent);

var obsPath = getLocationsHyperbolic(observed);
var sophPath = restaurantNameToPath.sophisticated;
console.log('obs, sophPath', obsPath, sophPath, _.isEqual(obsPath.slice(0,obsPath.length-1), sophPath));

// Inference only on utilities of Donut and Veg


var posterior = Enumerate(function () {
  var discount = 1;
  var type = 'sophisticated';
  var alpha = 500;
  var Udonut1 = uniformDraw([-10,  10, 20]);
  var Udonut2 = uniformDraw([-10,  10, 20]);
  var Uveg1   = uniformDraw([-10,  10, 20]);
  var Uveg2   = uniformDraw([-10,  10, 20]);

  var donutUtility = makeDonutUtility(world, {
      'Donut N' : [Udonut1, Udonut2],
      'Donut S' : [Udonut1, Udonut2],
      'Veg'     : [Uveg1, Uveg2],
      'Noodle'  : [0, 0]
  });

  var agent = makeHyperbolicDiscounter(
      { utility   : donutUtility,
        alpha     : alpha, 
        discount  : discount, 
        sophisticatedOrNaive  : type,
      }, world);
  var agentAction = agent.act;

  map(function (stateAction) {
    var state   = stateAction[0];
    var action  = stateAction[1];

    factor(agentAction(state, 0).score([], action)) ; 
  }, observed);

  return { Udonut1 : Udonut1, Udonut2 : Udonut2, 
           Uveg1 : Uveg1, Uveg2 : Uveg2
         };
});


if (typeof(document) !== 'undefined') { viz.print(posterior); }
else {printERP(posterior);}
